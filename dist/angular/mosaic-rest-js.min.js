!function(t,e){"use strict";"function"==typeof define&&define.amd?define(["jxon","angular"],e):"object"==typeof exports?module.exports=e(require("jxon"),require("request"),require("q")):t.BBRest=e(JXON,angular)}(this,function(t,e){"use strict";function r(){var t,e,r=arguments;for(t=1;t<r.length;t++)for(e in r[t])r[0][e]=r[t][e];return r[0]}function i(t){this.config=r({host:"localhost",port:"7777",context:"portalserver",username:"admin",password:"admin",plugin:null,portal:null},t||{})}function n(t,e,i){this.command=t,this.config=r({},e),this.uri=i,this.qs={},this.headers={"Content-Type":"application/xml"}}function s(t,e){var r;switch(typeof t){case"string":return a.ajax({type:"GET",dataType:"text",url:t}).fail(function(){return{error:!0,info:"Wrong URL"}});case"object":return r=new a.Deferred,r.resolve(e(t)),r.promise();default:return r=new a.Deferred,r.resolve(t),r.promise()}}function o(e){return t.stringToJs(e)}t.config({valueKey:"_",attrKey:"$",attrPrefix:"$",lowerCaseTags:!1,trueIsEmpty:!1,autoDate:!1,ignorePrefixedNodes:!1}),r(i.prototype,{server:function(){return new n("server",this.config,["portals"])},portal:function(){var t=["portals",this.config.portal];return new n("portal",this.config,t)},catalog:function(t){var e=["catalog"];return t&&e.push(t),new n("server",this.config,e)},portalCatalog:function(t){var e=["portals",this.config.portal,"catalog"];return t&&e.push(t),new n("portal",this.config,e)},container:function(t){var e=["portals",this.config.portal,"containers"];return t&&e.push(t),new n("container",this.config,e)},widget:function(t){var e=["portals",this.config.portal,"widgets"];return t&&e.push(t),new n("widget",this.config,e)},page:function(t){var e=["portals",this.config.portal,"pages"];return t&&e.push(t),new n("page",this.config,e)},link:function(t){var e=["portals",this.config.portal,"links"];return t&&e.push(t),new n("link",this.config,e)},user:function(t,e,r){var i=["users"];return t&&i.push(t),e&&i.push("groups"),r&&i.push(r),new n("user",this.config,i)},group:function(t,e,r){var i=["groups"];return t&&i.push(t),e&&i.push("users"),r&&i.push(r),new n("group",this.config,i)},template:function(t){var e=["templates"];return t&&e.push(t),new n("template",this.config,e)},audit:function(t){return new n("audit",this.config,[t?"auditmeta":"auditevents"])},cache:function(t){var e=["caches",t];return new n("cache",this.config,e)},"import":function(){},"export":function(){},auto:function(t,e){var r=this;return s(t,this.config.plugin).then(function(i){"string"==typeof i&&(i=o(i));var n=r.jxonToObj(i,e);return r[n[0]]()[n[1]](t)})},jxonToObj:function(t,e){var r,i,n,s,o=[],u=["container","widget","page","link","template","user","group"];for(r in t){for(i in t[r])break;switch(s=t[r][i].contextItemName,r){case"catalog":"[BBHOST]"===s?o.push("catalog","post"):o.push("portalCatalog","post");break;case"portals":o.push("server","post");break;case"portal":o.push("server","put");break;default:if(n="s"===r.charAt(r.length-1)){if(r.substr(0,r.length-1)!==i)throw new Error(r+" must be plural of "+i);o.push(i,"post")}else-1!==u.indexOf(r)?o.push(r,"put"):o.push(r,"post")}break}return e&&(o[1]=e),o}}),r(n.prototype,{rights:function(){return this.uri.push("rights"),this},tag:function(t,e){return this.uri.push("tags"),t&&this.uri.push(t),e&&(this.qs.type=e),this},query:function(t){return this.qs=t,this},get:function(){return"portals"===this.uri[0]&&2===this.uri.length&&(this.uri[1]+=".xml"),"catalog"===this.uri[2]&&this.uri[3]&&(this.uri[3]+=".xml"),"pages"===this.uri[2]&&this.uri[3]&&(this.uri[3]+=".xml"),"containers"===this.uri[2]&&this.uri[3]&&(this.uri[3]+=".xml"),"widgets"===this.uri[2]&&this.uri[3]&&(this.uri[3]+=".xml"),"links"===this.uri[2]&&this.uri[3]&&(this.uri[3]+=".xml"),this.method="GET",this.req()},post:function(t){return this.method="POST",this.doRequest(t)},put:function(t){return this.method="PUT",this.doRequest(t)},"delete":function(t){if(this.method="DELETE",t)switch(this.method="POST",this.command){case"server":this.uri=["delete","catalog"];break;case"portal":this.uri[2]="delete",this.uri[3]="catalog";break;case"link":this.uri[2]="delete",this.uri[3]="links"}return"cache"===this.command&&"all"===this.uri[1]?this.deleteAllCache(0):this.doRequest(t)},doRequest:function(t){var e=this;return s(t,this.config.plugin).then(function(t){return e.req(t)})},deleteAllCache:function(t){var e=this;return this.uri[1]=u[t],this.req().then(function(r){return!r.error&&t<u.length-1?e.deleteAllCache(++t):r})}});var u=["globalModelCache","retrievedWidgetCache","widgetChromeStaticCache","serverSideClosureCache","urlLevelCache","gModelCache","uuidFromExtendedItemNamesCache","springAclSidCacheRegion","contextNameToItemNameToUuidCache","widgetCache","uuidToContentReferencesCache","springAclCacheRegion","itemUuidToReferencingLinkUuidsCache","uuidToCacheKeysCache","versionBundleCache"],a=e;return n.prototype.req=function(t){var e=this,r="http://"+this.config.host+":"+this.config.port+"/"+this.config.context+"/"+this.uri.join("/"),i=a.param(this.qs);return i&&(r+="?"+i),null!==this.config.username&&(this.headers.Authorization="Basic "+btoa(this.config.username+":"+this.config.password)),a.ajax({type:this.method,url:r,dataType:"xml",headers:this.headers,data:t||""}).then(function(i,n,s){var o,u={statusCode:parseInt(s.status),statusInfo:s.statusCode,body:s.responseText,href:r,method:e.method,reqBody:t};return u.statusCode>=400?u.error=!0:302===u.statusCode?(o=u.headers.location.indexOf("errorMessage="),-1!==o&&(u.error=unescape(u.headers.location.substr(o+13)))):e.config.plugin&&u.body&&(u.body=e.config.plugin(u.body)),o=u.href.indexOf("errorMessage="),-1!==o&&(u.error=unescape(u.href.substr(o+13))),u}).fail(function(){return{error:!0,statusCode:null,ststusInfo:"Request failed",body:null,href:r,method:e.method,reqBody:t,file:e.file||null}})},i});